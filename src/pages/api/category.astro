---
export const partial = true;
import { db, Category } from 'astro:db';

if (Astro.request.method !== 'POST') return new Response(null, { status: 405 });

const formData = await Astro.request.formData();
const name = formData.get('name')?.toString();

if (!name) return new Response('Name is required', { status: 400 });

// Handle potential unique constraint error (simplistic approach)
let category;
try {
  [category] = await db.insert(Category).values({ name }).returning();
} catch (e) {
  return new Response('Category already exists', { status: 400 });
}
---

<div class="category-section" id={`category-${category.id}`}>
  <div class="category-header">
    <h2>
      {category.name}
    </h2>
    <div class="actions">
      <button class="icon-btn" @click={`document.getElementById('add-link-modal').classList.add('open'); document.getElementById('add-link-category-id').value = '${category.id}'`} title="Add Link">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </button>
      <button class="icon-btn danger" hx-delete={`/api/category/${category.id}`} hx-target={`#category-${category.id}`} hx-swap="outerHTML" hx-confirm="Are you sure you want to delete this category and all its links?" title="Delete Category">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
      </button>
    </div>
  </div>

  <div class="link-grid" id={`link-grid-${category.id}`}>
  </div>
  <div class="empty-state" id={`empty-state-${category.id}`}>
    No links yet. Add one to get started!
  </div>
</div>
<!-- Also remove the global empty state if it's there -->
<div id="global-empty-state" hx-swap-oob="delete"></div>
